---
name: Build and Push to GCP

on:
  push:
    branches: [ "main" ]

env:
  PROJECT_ID: pwd-project-17e8b
  REGION: asia-east1
  GAR_LOCATION: asia-east1-docker.pkg.dev/pwd-project-17e8b/images

jobs:
  build-push-artifact:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          version: v0.7.0

      - id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: "${{ secrets.SERVICE_ACCOUNT_KEY }}"

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Use gcloud CLI
        run: gcloud info

      - name: "Docker auth"
        run: |-
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet      

      - name: Build image
        run: docker build . --tag ${{ env.GAR_LOCATION }}
        working-directory: ''

      - name: Push image
        run: docker push ${{ env.GAR_LOCATION }}



#    env:
#      IMAGE_NAME: demo3
#      PROJECT_ID: pwd-project-17e8b
#
#    steps:
#    - uses: actions/checkout@v3
#    - name: Set up JDK 17
#      uses: actions/setup-java@v3
#      with:
#        java-version: '17'
#        distribution: 'temurin'
#        cache: maven
#    - name: Build with Maven
#      run: mvn -B package --file pom.xml
#
##    - uses: actions/checkout@v4
#
#    - uses: google-github-actions/setup-gcloud@v2
#      with:
#        service_account_key: ${{ secrets.SERVICE_ACCOUNT_KEY }}
#        project_id: ${{ env.PROJECT_ID }}
#        export_default_credentials: true
#
#    - name: Build Docker Image
#      run: docker build -t $IMAGE_NAME:latest .
#
##    - name: Automatic Tagging of Releases
##      id: increment-git-tag
##      run: bash ./scripts/git_update.sh -v major
#
#    - name: Configure Docker Client
#      run:  gcloud auth configure-docker asia-east1-docker.pkg.dev
#
#    - name: Push Docker Image to Artifact Registry
#      env:
#        GIT_TAG: v0.1.0
#      run: |-
#        docker tag $IMAGE_NAME:latest asia-east1-docker.pkg.dev/$PROJECT_ID/images/$IMAGE_NAME:latest
#        docker tag $IMAGE_NAME:latest asia-east1-docker.pkg.dev/$PROJECT_ID/images/$IMAGE_NAME:$GIT_TAG
#        docker push asia-east1-docker.pkg.dev/$PROJECT_ID/images/$IMAGE_NAME:latest
#        docker push asia-east1-docker.pkg.dev/$PROJECT_ID/images/$IMAGE_NAME:$GIT_TAG
